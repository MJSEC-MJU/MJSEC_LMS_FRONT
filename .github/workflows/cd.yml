name: CD

on:
  push:
    branches: ['main']

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    #───────────────────────────────────────────────────────────#
    # 0)  코드를 체크아웃 + Buildx
    #───────────────────────────────────────────────────────────#
    - uses: actions/checkout@v4
    - uses: docker/setup-buildx-action@v3

    #───────────────────────────────────────────────────────────#
    # 1)  이미지 태그 (소문자)
    #───────────────────────────────────────────────────────────#
    - name: Prepare image tag
      id: prep
      run: echo "image_tag=ghcr.io/${GITHUB_REPOSITORY,,}:latest" >>"$GITHUB_OUTPUT"

    #───────────────────────────────────────────────────────────#
    # 2)  GHCR 로그인 + Build & Push
    #───────────────────────────────────────────────────────────#
    - name: Log in to ghcr.io
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build & push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./mjsec-frontend
        file:    ./mjsec-frontend/Dockerfile
        push:    true
        tags:    ${{ steps.prep.outputs.image_tag }}

    #───────────────────────────────────────────────────────────#
    # 3)  원격 서버 배포
    #───────────────────────────────────────────────────────────#
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host:       ${{ secrets.HOST }}
        port:       ${{ secrets.SSH_PORT }}
        username:   ${{ secrets.USER }}
        key:        ${{ secrets.SSH_KEY }}

        script: |
          set -euo pipefail

          ######################################################
          ## ①  코드 디렉터리 준비
          ######################################################
          if [ ! -d /srv/mjsec/.git ]; then
            git clone --branch main https://github.com/MJSEC-MJU/MJSEC_LMS_FRONT /srv/mjsec
          fi
          cd /srv/mjsec
          git fetch origin main
          git reset --hard origin/main

          ######################################################
          ## ②  .env 생성 + export  (Compose 전달용)
          ######################################################
          cat > .env <<EOF
          ORG=mjsec-mju
          REPO=mjsec_lms_front
          DOMAIN=mjsec.kr
          EMAIL=***@gmail.com

          # nginx upstream host:port
          APP_UPSTREAM=app:80
          EOF

          echo "--- .env ---"
          cat .env
          echo "--------------"

          # 모든 키/값 자동 export
          set -o allexport
          . ./.env
          set +o allexport

          ######################################################
          ## ③  GHCR 로그인 (서버 pull)
          ######################################################
          if [ -n "***" ]; then
            echo "***" \
              | docker login ghcr.io -u jongcoding --password-stdin
          fi

          ##############################
          # ④  HTTP-only nginx 기동 (부트스트랩 전용)
          ##############################
          export BOOTSTRAP=http
          docker compose --env-file .env \
            -f mjsec-frontend/docker-compose.prod.yaml up -d nginx

          ##############################
          # ⑤  최초 또는 갱신 Certbot (HTTP-only 모드 유지)
          ##############################
          mjsec-frontend/docker/scripts/init-letsencrypt.sh

          # 부트스트랩 완료 후 HTTP-only 모드 변수 해제
          unset BOOTSTRAP

          ##############################
          # ⑥  전체 스택 SSL 모드 재기동
          ##############################
          docker compose --env-file .env \
            -f mjsec-frontend/docker-compose.prod.yaml pull

          docker compose --env-file .env \
            -f mjsec-frontend/docker-compose.prod.yaml up -d --remove-orphans

          ######################################################
          ## ⑦  디스크 청소
          ######################################################
          docker image prune -f

