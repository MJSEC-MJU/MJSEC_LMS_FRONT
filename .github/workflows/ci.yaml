name: CI

on:
  pull_request:
  push:
    branches: [ "feature/**" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      # 1) build & up
      - name: Compose up (build & run)
        run: |
          docker compose -f mjsec-frontend/docker-compose.ci.yml up -d
          docker compose -f mjsec-frontend/docker-compose.ci.yml ps

      # 2) health 대기 → HEAD 200 확인
      - name: Smoke test (HTTP 200)
        run: |
          # docker compose wait 은 Compose v2.24+ 필요
          docker compose -f mjsec-frontend/docker-compose.ci.yml \
            wait --timeout 60s app   # 60초 타임아웃
          # 컨테이너가 healthy 가 되면 HEAD만 날려 200 확인
          curl --fail --silent --head http://localhost:8080

      # 3) 항상 정리
      - name: Tear down
        if: always()
        run: docker compose -f mjsec-frontend/docker-compose.ci.yml down -v
