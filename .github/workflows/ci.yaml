# .github/workflows/ci.yaml
name: CI

on:
  pull_request:
  push:
    branches: [ "feature/**" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      # 1) Build & Run (포트 8080 → 컨테이너 80)
      - name: Compose up (build & run)
        run: |
          docker compose -f mjsec-frontend/docker-compose.ci.yml up -d
          docker compose -f mjsec-frontend/docker-compose.ci.yml ps

      # 2) 수동 재시도 루프(최대 60초)로 HTTP 200 확인
      - name: Smoke test (HTTP 200)
        run: |
          # 최대 30회 × 2초 = 60초 동안 HEAD 200 을 기다립니다.
          for i in {1..30}; do
            if curl -fs --head http://localhost:8080 >/dev/null ; then
              echo "✅  app responded (try $i)"; exit 0
            fi
            echo "⌛  waiting... ($i/30)"; sleep 2
          done
          echo "❌  app did not respond in time"; exit 1

      # 3) 항상 정리
      - name: Tear down
        if: always()
        run: docker compose -f mjsec-frontend/docker-compose.ci.yml down -v
