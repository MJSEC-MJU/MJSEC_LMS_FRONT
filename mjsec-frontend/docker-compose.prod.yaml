services:
  app:
    image: ghcr.io/${ORG}/${REPO}:latest
    restart: always

  nginx:
    image: nginx:stable-alpine
    restart: always
    depends_on:
      - app
    environment:                 # ðŸ‘ˆ í…œí”Œë¦¿ ì¹˜í™˜ ëŒ€ìƒ ë³€ìˆ˜
      DOMAIN: ${DOMAIN}
      APP_UPSTREAM: app:80
    volumes:
      # í…œí”Œë¦¿ íŒŒì¼ë§Œ ë§ˆìš´íŠ¸ âžœ /etc/nginx/templates/...
      - ./docker/nginx/default.prod.template:/etc/nginx/templates/default.prod.template:ro
      # Certbot ì¸ì¦ì„œ ê²½ë¡œ
      - certbot-etc:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot
    ports:
      - "80:80"
      - "443:443"

  certbot:
    image: certbot/certbot:latest
    entrypoint: >
      sh -c "trap exit TERM; while :; do sleep 12h & wait $${!};
             certbot renew --webroot -w /var/www/certbot --quiet \
             && nginx -s reload; done"
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot

volumes:
  certbot-etc:
  certbot-webroot:
