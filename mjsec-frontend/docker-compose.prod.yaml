services:
  app:
    image: ghcr.io/${ORG}/${REPO}:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      FLASK_ENV: production
    expose:
      - "80"

  # ── Wiki.js DB
  wiki-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: wikijs
      POSTGRES_USER: wikijs
      POSTGRES_PASSWORD: ${WIKI_DB_PASSWORD:?set in .env}
    volumes:
      - ./wikijs/db:/var/lib/postgresql/data

  # ── Wiki.js App
  wiki:
    image: requarks/wiki:2
    depends_on:
      - wiki-db
    restart: unless-stopped
    environment:
      DB_TYPE: postgres
      DB_HOST: wiki-db
      DB_PORT: 5432
      DB_USER: wikijs
      DB_PASS: ${WIKI_DB_PASSWORD}
      DB_NAME: wikijs
    expose:
      - "3000"

  # ── Nginx (가상호스팅: DOMAIN / WIKI_DOMAIN)
  nginx:
    container_name: nginx
    image: nginx:alpine
    depends_on:
      - app
      - wiki
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf.template:/etc/nginx/templates/default.conf.template:ro
      - ./certbot/config:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    environment:
      DOMAIN: ${DOMAIN}
      # Compose 기본값 문법으로 fallback 처리 (쉘의 := 제거)
      WIKI_DOMAIN: ${WIKI_DOMAIN:-wiki.${DOMAIN}}
    entrypoint:
      - sh
      - -exc
      - |
        # envsubst로 템플릿 렌더
        envsubst '$DOMAIN $WIKI_DOMAIN' < /etc/nginx/templates/default.conf.template \
          > /etc/nginx/conf.d/default.conf
        exec nginx -g 'daemon off;'
    restart: unless-stopped

  # ── 최초 인증서 발급 (메인 + 위키 서브도메인 동시)
  certbot:
    image: certbot/certbot
    environment:
      DOMAIN: ${DOMAIN}
      EMAIL: ${EMAIL}
      # 동일하게 Compose 기본값으로 wiki 서브도메인 기본값 제공
      WIKI_DOMAIN: ${WIKI_DOMAIN:-wiki.${DOMAIN}}
      # 선택: 기존 단일 인증서에 도메인 추가 시 --expand 사용
      CERTBOT_EXTRA_ARGS: ${CERTBOT_EXTRA_ARGS:-}
    volumes:
      - ./certbot/config:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint:
      - sh
      - -exc
      - |
        exec certbot certonly --webroot \
          --webroot-path=/var/www/certbot \
          --non-interactive --agree-tos \
          --email "${EMAIL}" \
          -d "${DOMAIN}" -d "${WIKI_DOMAIN}" ${CERTBOT_EXTRA_ARGS}
    restart: "no"

  # ── 자동 갱신 + Nginx reload
  certbot-renew:
    image: certbot/certbot
    volumes:
      - ./certbot/config:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: >
      sh -c "while true; do
               certbot renew --quiet --deploy-hook 'docker exec nginx nginx -s reload';
               sleep 12h;
             done"
    restart: unless-stopped
