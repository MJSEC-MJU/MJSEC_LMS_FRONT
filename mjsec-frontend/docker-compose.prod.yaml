services:
  app:
    image: ghcr.io/<ORG>/mjsec-frontend:latest  # CI에서 빌드·Push된 이미지
    restart: always

  nginx:
    image: nginx:stable-alpine
    restart: always
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/ssl.conf:/etc/nginx/conf.d/ssl.conf:ro
      - certbot-etc:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - app

  certbot:
    image: certbot/certbot:latest
    entrypoint: >
      sh -c "trap exit TERM; while :; do sleep 12h & wait $${!};
             certbot renew --webroot -w /var/www/certbot --quiet
             && nginx -s reload; done"
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot

volumes:
  certbot-etc:
  certbot-webroot:
