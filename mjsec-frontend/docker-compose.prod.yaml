# docker-compose.prod.yaml
version: '3.8'

services:
  app:
    image: ghcr.io/${ORG}/${REPO}:latest
    restart: always

  nginx:
    image: nginx:stable-alpine
    restart: always
    depends_on:
      - app
    environment:
      DOMAIN: ${DOMAIN}
      APP_UPSTREAM: app:80
    volumes:
      # 템플릿(.conf.template)만 마운트
      - ./docker/nginx/default.${BOOTSTRAP:-ssl}.conf.template:/etc/nginx/templates/default.conf.template:ro
      # Certbot 볼륨
      - certbot-etc:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot
    ports:
      - "80:80"
      - "443:443"
    entrypoint: ["sh", "-c"]
    command: |
      # 1) 템플릿 치환
      envsubst '${DOMAIN} ${APP_UPSTREAM}' \
        < /etc/nginx/templates/default.conf.template \
        > /etc/nginx/conf.d/default.conf

      # 2) nginx 실행
      exec nginx -g 'daemon off;'

  certbot:
    image: certbot/certbot:latest
    entrypoint: ["sh", "-c"]
    command: |
      trap exit TERM
      while :
      do
        sleep 12h & wait $${!}
        certbot renew --webroot -w /var/www/certbot --quiet \
          && nginx -s reload
      done
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot

volumes:
  certbot-etc:
  certbot-webroot:
